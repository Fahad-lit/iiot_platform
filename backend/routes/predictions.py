"""\nÙ…Ø³Ø§Ø±Ø§Øª API Ù„Ù„ØªÙ†Ø¨Ø¤Ø§Øª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ\nAPI Routes for Predictions and AI/ML\n"""\n\nfrom fastapi import APIRouter, HTTPException, Query\nfrom typing import Optional\nimport logging\nfrom services.ml_service import ml_service\n\nlogger = logging.getLogger(__name__)\n\nrouter = APIRouter(\n    prefix=\"/api/predictions\",\n    tags=[\"predictions\"],\n    responses={404: {\"description\": \"Not found\"}}\n)\n\n@router.get(\"/failure/{device_id}\")\nasync def predict_device_failure(\n    device_id: str,\n    measurement_type: str = Query(..., description=\"Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³\"),\n    time_range: str = Query(\"-30d\", description=\"Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ\")\n):\n    \"\"\"\n    Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \n    ÙŠØ³ØªØ®Ø¯Ù… Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù„Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© ÙØ´Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \n    ÙŠØ¹ÙŠØ¯:\n    - Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ© Ø§Ù„ÙØ´Ù„ (0-1)\n    - Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ø­ØªÙ‰ Ø§Ù„ÙØ´Ù„\n    - Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø± (low, medium, high, critical)\n    - Ø§Ù„ØªÙˆØµÙŠØ§Øª\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ¤– Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø£Ø¹Ø·Ø§Ù„ Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        result = await ml_service.predict_device_failure(\n            device_id, measurement_type, time_range\n        )\n        return result\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†Ø¨Ø¤: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/maintenance/{device_id}\")\nasync def predict_maintenance(\n    device_id: str,\n    measurement_type: str = Query(..., description=\"Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³\")\n):\n    \"\"\"\n    Ø§Ù„ØªÙ†Ø¨Ø¤ Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©\n    \n    ÙŠØ­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ù„Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¯Ù‡ÙˆØ±\n    \n    ÙŠØ¹ÙŠØ¯:\n    - ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­\n    - Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø­ØªÙ‰ Ø§Ù„ØµÙŠØ§Ù†Ø©\n    - Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n    - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ”§ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø©: {device_id}\")\n        result = await ml_service.predict_maintenance_schedule(\n            device_id, measurement_type\n        )\n        return result\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/anomalies/{device_id}\")\nasync def detect_anomalies_ml(\n    device_id: str,\n    measurement_type: str = Query(..., description=\"Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³\"),\n    contamination: float = Query(0.1, ge=0.01, le=0.5, description=\"Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ„ÙˆØ«\")\n):\n    \"\"\"\n    ÙƒØ´Ù Ø§Ù„Ø´Ø°ÙˆØ° Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ\n    \n    ÙŠØ³ØªØ®Ø¯Ù… Isolation Forest Ù„ÙƒØ´Ù Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø§Ø°Ø©\n    \n    ÙŠØ¹ÙŠØ¯:\n    - Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø°ÙˆØ° Ø§Ù„Ù…ÙƒØªØ´ÙØ©\n    - ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø´Ø°ÙˆØ°\n    - Ø¯Ø±Ø¬Ø© Ø§Ù„Ø´Ø°ÙˆØ° (anomaly score)\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ” ÙƒØ´Ù Ø§Ù„Ø´Ø°ÙˆØ°: {device_id}\")\n        result = await ml_service.detect_anomalies_ml(\n            device_id, measurement_type, contamination\n        )\n        return result\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒØ´Ù Ø§Ù„Ø´Ø°ÙˆØ°: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/health-score/{device_id}\")\nasync def get_device_health_score(\n    device_id: str,\n    measurement_type: str = Query(..., description=\"Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³\")\n):\n    \"\"\"\n    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© ØµØ­Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \n    ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø¹Ø¯Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© ØµØ­Ø© Ø´Ø§Ù…Ù„Ø©\n    \n    ÙŠØ¹ÙŠØ¯:\n    - Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ­Ø© (0-100)\n    - Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø©\n    - Ø§Ù„ØªÙˆØµÙŠØ§Øª\n    \"\"\"\n    try:\n        logger.info(f\"â¤ï¸ Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© ØµØ­Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø¬Ù„Ø¨ Ø§Ù„ØªÙ†Ø¨Ø¤\n        failure_pred = await ml_service.predict_device_failure(\n            device_id, measurement_type\n        )\n        \n        # Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ­Ø©\n        if 'failure_probability' in failure_pred:\n            health_score = int((1 - failure_pred['failure_probability']) * 100)\n        else:\n            health_score = 50\n        \n        return {\n            \"device_id\": device_id,\n            \"health_score\": health_score,\n            \"status\": \"excellent\" if health_score >= 80 else \"good\" if health_score >= 60 else \"fair\" if health_score >= 40 else \"poor\",\n            \"failure_probability\": failure_pred.get('failure_probability', 0),\n            \"recommendations\": failure_pred.get('recommendations', [])\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„ØµØ­Ø©: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/batch-analysis\")\nasync def batch_analysis(\n    device_ids: str = Query(..., description=\"Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„\"),\n    measurement_type: str = Query(..., description=\"Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³\")\n):\n    \"\"\"\n    ØªØ­Ù„ÙŠÙ„ Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©\n    \n    ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªÙ†Ø¨Ø¤ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ø¹Ø¯Ø© Ø£Ø¬Ù‡Ø²Ø© ÙÙŠ Ø·Ù„Ø¨ ÙˆØ§Ø­Ø¯\n    \"\"\"\n    try:\n        device_list = [d.strip() for d in device_ids.split(\",\")]\n        logger.info(f\"ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø¯ÙØ¹Ø© Ù…Ù† {len(device_list)} Ø¬Ù‡Ø§Ø²\")\n        \n        results = []\n        for device_id in device_list:\n            prediction = await ml_service.predict_device_failure(\n                device_id, measurement_type\n            )\n            results.append(prediction)\n        \n        return {\n            \"total_devices\": len(device_list),\n            \"devices_analyzed\": len([r for r in results if 'failure_probability' in r]),\n            \"results\": results\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ÙŠ: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n
