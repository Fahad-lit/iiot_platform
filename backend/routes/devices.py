"""
Ù…Ø³Ø§Ø±Ø§Øª API Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
API Routes for Devices Management
"""

from fastapi import APIRouter, HTTPException, Query
from typing import Optional, List
from datetime import datetime
import logging
from models import DeviceCreate, Device, DeviceStatus

logger = logging.getLogger(__name__)

router = APIRouter(\n    prefix=\"/api/devices\",\n    tags=[\"devices\"],\n    responses={404: {\"description\": \"Not found\"}}\n)\n\n@router.get(\"/\")\nasync def get_devices(\n    status: Optional[str] = Query(None, description=\"ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©\"),\n    device_type: Optional[str] = Query(None, description=\"ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹\"),\n    limit: int = Query(100, ge=1, le=1000),\n    offset: int = Query(0, ge=0)\n):\n    \"\"\"\n    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©\n    \n    - **status**: ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (active, inactive, maintenance, error)\n    - **device_type**: ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (sensor, actuator, controller, gateway)\n    - **limit**: Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø§ÙØªØ±Ø§Ø¶ÙŠ: 100)\n    - **offset**: Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØªØ®Ø·Ø§Ø©\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ“± Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ PostgreSQL\n        return {\n            \"devices\": [],\n            \"total\": 0,\n            \"limit\": limit,\n            \"offset\": offset,\n            \"filters\": {\n                \"status\": status,\n                \"device_type\": device_type\n            },\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\"\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.post(\"/\")\nasync def create_device(device: DeviceCreate):\n    \"\"\"\n    Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯\n    \n    - **device_id**: Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¬Ù‡Ø§Ø² (Ù…Ø·Ù„ÙˆØ¨)\n    - **device_name**: Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø² (Ù…Ø·Ù„ÙˆØ¨)\n    - **device_type**: Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² (sensor, actuator, controller, gateway)\n    - **location**: Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)\n    \"\"\"\n    try:\n        logger.info(f\"â• Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯: {device.device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device\": device.dict()\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù‡Ø§Ø²: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/{device_id}\")\nasync def get_device(device_id: str):\n    \"\"\"\n    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø¬Ù‡Ø§Ø² Ù…Ø¹ÙŠÙ†\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ“± Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"device_id\": device_id,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\"\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù‡Ø§Ø²: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.put(\"/{device_id}\")\nasync def update_device(device_id: str, device_data: dict):\n    \"\"\"\n    ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \"\"\"\n    try:\n        logger.info(f\"âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device_id\": device_id\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù‡Ø§Ø²: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.delete(\"/{device_id}\")\nasync def delete_device(device_id: str):\n    \"\"\"\n    Ø­Ø°Ù Ø¬Ù‡Ø§Ø²\n    \n    ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!\n    \"\"\"\n    try:\n        logger.warning(f\"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device_id\": device_id\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¬Ù‡Ø§Ø²: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.patch(\"/{device_id}/status\")\nasync def update_device_status(\n    device_id: str,\n    status: str = Query(..., description=\"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\")\n):\n    \"\"\"\n    ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \n    Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©: active, inactive, maintenance, error\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id} -> {status}\")\n        \n        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø­Ø§Ù„Ø©\n        valid_statuses = [s.value for s in DeviceStatus]\n        if status not in valid_statuses:\n            raise HTTPException(\n                status_code=400,\n                detail=f\"Ø­Ø§Ù„Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©: {', '.join(valid_statuses)}\"\n            )\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device_id\": device_id,\n            \"new_status\": status\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/{device_id}/config\")\nasync def get_device_config(device_id: str):\n    \"\"\"\n    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \"\"\"\n    try:\n        logger.info(f\"âš™ï¸ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"device_id\": device_id,\n            \"config\": {},\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\"\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.put(\"/{device_id}/config\")\nasync def update_device_config(device_id: str, config: dict):\n    \"\"\"\n    ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \"\"\"\n    try:\n        logger.info(f\"âš™ï¸ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device_id\": device_id\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.get(\"/{device_id}/commands\")\nasync def get_device_commands(device_id: str):\n    \"\"\"\n    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¬Ù‡Ø§Ø²\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ® Ø¬Ù„Ø¨ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"device_id\": device_id,\n            \"commands\": [],\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\"\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n\n@router.post(\"/{device_id}/commands\")\nasync def send_command_to_device(device_id: str, command: dict):\n    \"\"\"\n    Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²\n    \"\"\"\n    try:\n        logger.info(f\"ğŸ® Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²: {device_id}\")\n        \n        # Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\n        return {\n            \"success\": True,\n            \"message\": \"Ø³ÙŠØªÙ… ØªØ·ÙˆÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø§Ø­Ù‚Ù‹Ø§\",\n            \"device_id\": device_id,\n            \"command\": command\n        }\n    \n    except Exception as e:\n        logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ù…Ø±: {str(e)}\")\n        raise HTTPException(status_code=500, detail=str(e))\n
